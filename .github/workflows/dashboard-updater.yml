name: Update Community Dashboard

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
  issues:
    types: [opened, closed, labeled]

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Fetch GitHub Data and Update Dashboard
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const allIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner, repo,
              state: 'all',
              per_page: 100
            });

            const issues = allIssues.filter(i => !i.pull_request);

            let contributors = [];
            try {
              const contribResponse = await github.rest.repos.listContributors({
                owner, repo,
                per_page: 15
              });
              contributors = contribResponse.data || [];
            } catch (e) {
              console.log('Could not fetch contributors');
            }

            const openIssues = issues.filter(i => i.state === 'open');
            const closedIssues = issues.filter(i => i.state === 'closed');
            const inProgress = openIssues.filter(i => 
              i.labels.some(l => l.name === 'status: in-progress')
            );
            const available = openIssues.filter(i => 
              i.labels.some(l => l.name === 'status: available')
            );
            const goodFirstIssues = openIssues.filter(i =>
              i.labels.some(l => l.name.toLowerCase().includes('good first') || l.name.toLowerCase().includes('beginner'))
            );
            const blocked = openIssues.filter(i =>
              i.labels.some(l => l.name.toLowerCase().includes('blocked') || l.name.toLowerCase().includes('help wanted'))
            );

            const dashboardIssues = await github.rest.issues.listForRepo({
              owner, repo,
              labels: 'dashboard,automated',
              state: 'open'
            });

            let dashboardIssue;

            if (dashboardIssues.data.length > 0) {
              dashboardIssue = dashboardIssues.data[0];
            } else {
              const newIssue = await github.rest.issues.create({
                owner, repo,
                title: 'Community Contribution Dashboard',
                body: 'Loading dashboard data...',
                labels: ['dashboard', 'automated', 'documentation']
              });
              dashboardIssue = newIssue.data;
            }

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toISOString().split('T')[1].split('.')[0];

            let beginnerList = '';
            if (goodFirstIssues.length > 0) {
              beginnerList = goodFirstIssues.slice(0, 5).map(i => '- #' + i.number + ': ' + i.title).join('\n');
            }

            let contribList = '';
            if (contributors.length > 0) {
              contribList = contributors.slice(0, 10).map((c, i) => (i + 1) + '. @' + c.login + ' (' + c.contributions + ' contributions)').join('\n');
            } else {
              contribList = '_No contributors yet_';
            }

            const dashboardContent = '# Community Contribution Dashboard\n\n' +
              '*Last updated: ' + dateStr + ' at ' + timeStr + ' UTC*\n\n' +
              '## Overview\n' +
              '| Metric | Count |\n' +
              '|--------|-------|\n' +
              '| Total Issues | ' + issues.length + ' |\n' +
              '| Open Issues | ' + openIssues.length + ' |\n' +
              '| Closed Issues | ' + closedIssues.length + ' |\n' +
              '| In Progress | ' + inProgress.length + ' |\n' +
              '| Available | ' + available.length + ' |\n' +
              '| Good First Issues | ' + goodFirstIssues.length + ' |\n' +
              '| Contributors | ' + contributors.length + ' |\n\n' +
              '## Good First Issues\n' + (beginnerList || '_None available_') + '\n\n' +
              '## Top Contributors\n' + contribList + '\n\n' +
              '## Quick Links\n' +
              '- [All Open Issues](https://github.com/' + owner + '/' + repo + '/issues?q=is%3Aopen+is%3Aissue)\n' +
              '- [Good First Issues](https://github.com/' + owner + '/' + repo + '/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22)\n\n' +
              '## How to Contribute\n' +
              '1. Find an issue you would like to work on\n' +
              '2. Comment `/assign` to claim it\n' +
              '3. Use `/status` to check your current assignments\n' +
              '4. Create a PR when ready\n\n' +
              '---\n' +
              '*This dashboard updates automatically every 6 hours.*';

            await github.rest.issues.update({
              owner, repo,
              issue_number: dashboardIssue.number,
              body: dashboardContent
            });

            console.log('Dashboard updated successfully!');
